import math
import pandas as pd
from bpllib import utils

METRIC = 'accuracy'
DATASETS = utils.easy_datasets + ['-'] + utils.medium_datasets + ['-'] + utils.hard_datasets
METHODS = ['Find-RS', 'RIPPER', 'ID3']

df = pd.read_pickle('../results.pkl')

# filter out SVM and RF and keep only single and bp strategies
df = df[~df['method'].isin(['SVM', 'RF'])]
df = df[df['strategy'].isin(['single', 'bp'])]

print("% autogenerated by baselines_table.py")
print("""
\\begin{table}[ht]
\\centering
\\small

\\begin{tabular}{ l | c  c c c c c c c c}
\\hline
""")

# print table headers
print('& \\multicolumn{4}{c}{Single} & \\multicolumn{4}{c}{BP} & \\\\ \\cline{2-5} \\cline{6-9}')
for method in METHODS:
    print(f'& {method} ', end='')
print('& Mean \\\\ \\hline')

for dataset in DATASETS:
    if dataset == '-':
        print(f'\\hline')
        continue
    print(f'\\texttt{{{dataset}}} ', end='')

    single_avgs = []
    bp_avgs = []
    for method in METHODS:
        single_avg_metric = df[(df['dataset'] == dataset) & (df['method'] == method) & (df['strategy'] == 'single')][
            METRIC].mean()
        bp_avg_metric = df[(df['dataset'] == dataset) & (df['method'] == method) & (df['strategy'] == 'bp')][
            METRIC].mean()

        single_avgs.append(single_avg_metric)
        bp_avgs.append(bp_avg_metric)

        marker = ""
        delta = bp_avg_metric - single_avg_metric
        if not math.isnan(delta):
            if delta > 0:
                marker = "\\textbf{+}"
            elif delta < 0:
                marker = "\\textbf{-}"
        print(f'& {single_avg_metric:.4f} & {bp_avg_metric:.4f} & {marker}{abs(delta):.4f} & ', end='')

    # print mean improvement
    mean_delta = sum([bp_avgs[i] - single_avgs[i] for i in range(len(METHODS)) if
                      not math.isnan(bp_avgs[i] - single_avgs[i])]) / len(METHODS)
    marker = ""
    if mean_delta > 0:
        marker = "\\textbf{+}"
    elif mean_delta < 0:
        marker = "\\textbf{-}"
    print(f'{marker}{abs(mean_delta):.4f} \\\\')

print("""
\\hline
\\end{tabular}
\\caption{\\label{tab:baselines} Comparison of the baselines using single and bp strategies. 
One-hot encoding was used if it was the best-performing one (marked with $\\dagger$). 
The mean improvement of BP over Single is reported, with positive improvements highlighted in \\textbf{bold}.}

\\end{table}
""")
